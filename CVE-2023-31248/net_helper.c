#include "net_helper.h"
#include "libnftnl/include/libnftnl/table.h"
#include <stdint.h>

struct nftnl_chain *build_chain(const char *chain_name, const char *table_name,
                                struct unft_base_chain_param *base_param,
                                int chain_id) {
  struct nftnl_chain *chain;

  chain = nftnl_chain_alloc();
  if (chain == NULL) {
    perror("OOM");
    return NULL;
  }
  nftnl_chain_set_str(chain, NFTNL_CHAIN_TABLE, table_name);
  nftnl_chain_set_str(chain, NFTNL_CHAIN_NAME, chain_name);

  if (base_param) {
    nftnl_chain_set_u32(chain, NFTNL_CHAIN_HOOKNUM, base_param->hook_num);
    nftnl_chain_set_u32(chain, NFTNL_CHAIN_PRIO, base_param->prio);
  }

  if (chain_id) {
    nftnl_chain_set_u32(chain, NFTNL_CHAIN_ID, chain_id);
  }

  return chain;
}

struct nftnl_rule *build_rule(char *table_name, char *chain_name,
                              uint16_t family, uint64_t *handle) {
  struct nftnl_rule *r = NULL;
  uint8_t proto;

  r = nftnl_rule_alloc();

  nftnl_rule_set_str(r, NFTNL_RULE_TABLE, table_name);
  nftnl_rule_set_str(r, NFTNL_RULE_CHAIN, chain_name);
  nftnl_rule_set_u32(r, NFTNL_RULE_FAMILY, family);

  if (handle) {
    nftnl_rule_set_u64(r, NFTNL_RULE_POSITION, *handle);
  }

  return r;
}

struct nftnl_table *build_table(const char *table_name, uint16_t family) {
  struct nftnl_table *t = nftnl_table_alloc();
  nftnl_table_set_u32(t, NFTNL_TABLE_FAMILY, family);
  nftnl_table_set_str(t, NFTNL_TABLE_NAME, table_name);
  return t;
}