CC=clang
CFLAGS=-masm=intel -static -std=gnu11 -I/home/robbert/research/CVE-2023-31248/libnftnl/build/include -I/home/robbert/research/CVE-2023-31248/libmnl/build/include
LDFLAGS=-L/home/robbert/research/CVE-2023-31248/libmnl/build/src/.libs -L/home/robbert/research/CVE-2023-31248/libnftnl/build/src/.libs -lnftnl -lmnl
RELEASE=CVE-2023-31248
HARDENING="kaslr"

oke: msg_helper.o net_helper.o oke.o
	$(CC) $(CFLAGS) *.o $(LDFLAGS) -o oke

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

copy: oke
	sudo losetup -fP rootfs_v3.img && \
	sudo mount -o discard -t ext4 /dev/loop0p1 rootfs && \
	sudo cp oke rootfs/chroot/ && \
	sudo umount rootfs && \
	sudo losetup -d /dev/loop0

runDebug: copy
	exec qemu-system-x86_64 -m 3.5G -no-reboot -nographic -s \
	-monitor none \
	-enable-kvm -cpu host -smp cores=2 \
	-kernel builds/lts-6.1.55/arch/x86/boot/bzImage \
	-initrd ramdisk_v1.img \
	-nic user,model=virtio-net-pci \
	-drive file=rootfs_v3.img,if=virtio,cache=none,aio=native,format=raw,discard=on,readonly=on \
	-drive file=/flag,if=virtio,format=raw,readonly=on \
	-append "console=ttyS0 root=/dev/vda1 rootfstype=ext4 rootflags=discard ro loglevel=7 nokaslr init=/home/user/run.sh hostname=$(RELEASE)"


run: copy
	exec qemu-system-x86_64 -m 3.5G -no-reboot -nographic \
	-monitor none \
	-enable-kvm -cpu host -smp cores=2 \
	-kernel builds/lts-6.1.55/arch/x86/boot/bzImage \
	-initrd ramdisk_v1.img \
	-nic user,model=virtio-net-pci \
	-drive file=rootfs_v3.img,if=virtio,cache=none,aio=native,format=raw,discard=on,readonly=on \
	-drive file=/flag,if=virtio,format=raw,readonly=on \
	-append "console=ttyS0 root=/dev/vda1 rootfstype=ext4 rootflags=discard ro loglevel=7 $(HARDENING) init=/home/user/run.sh hostname=$(RELEASE)"

clean:
	rm -rf oke *.o