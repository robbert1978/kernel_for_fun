KERNEL=vmlinuz-5.8.0-49-generic #linux-source-5.8.0/debian/build/build-generic/arch/x86/boot/bzImage
IMAGE=image
EXPFILE=exp
CC=clang
CFLAGS := -Wall -masm=intel -static -std=c2x -pthread


userfault: userfault.c
	$(CC) $(CFLAGS) -c $^

exp: userfault
	$(CC) $(CFLAGS) -lrt -lpthread -o $(EXPFILE) exp.c *.o

compress: exp
	cd image && \
	sudo cp ../$(EXPFILE) ./chroot/ && \
	./create-bullseye.sh && \
	cd -

debug: clean compress
	qemu-system-x86_64 -enable-kvm \
	-cpu qemu64,+smep,+smap \
	-m 2G \
	-smp 2 \
	-kernel $(KERNEL) \
	-append "console=ttyS0 root=/dev/sda earlyprintk=ttyS0 net.ifnames=0 nokaslr" \
	-drive file=$(IMAGE)/bullseye.img,format=raw,cache=none \
	-net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \
	-net nic,model=e1000 \
	-nographic -s

run: clean compress
	qemu-system-x86_64 -enable-kvm \
	-m 2G \
	-smp 2 \
	-kernel $(KERNEL) \
	-append "console=ttyS0 root=/dev/sda earlyprintk=ttyS0 net.ifnames=0 kaslr" \
	-drive file=$(IMAGE)/bullseye.img,format=raw,cache=none \
	-net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \
	-net nic,model=e1000 \
	-nographic

clean:
	rm -rf $(EXPFILE) *.o